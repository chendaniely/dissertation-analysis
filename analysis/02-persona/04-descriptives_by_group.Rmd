---
title: "Descriptives by Group"
output: 
  html_document: 
    toc: yes
editor_options: 
  chunk_output_type: console
params:
  num_clusters: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readr)
library(here)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
library(RColorBrewer)
library(knitr)
library(kableExtra)

plot_question_bar <- function(dat) {
  ggplot(data = dat,
         aes(x = stringr::str_wrap(response, 60),
             y = n,
             fill=as.factor((!!sym(gp_col))))
  ) +
    geom_bar(stat = "identity",
             position = "dodge2") +
    xlab("") +
    ylab("Count") +
    scale_fill_manual(name = "Cluster",
                      values = .GlobalEnv$COLORS) +
    #labels(line_break(dat$response)) +
    coord_flip() +
    ggtitle(stringr::str_wrap(dat$question_text, 80)) +
    theme_minimal() +
    theme(
      plot.title.position = "plot",
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black")
      
    )
}

fs::dir_create(here("./output", "persona", glue::glue("group_descriptives_{params$num_clusters}")), recurse = TRUE)


# generated from clustering.Rmd
persona <- readr::read_tsv(here(glue::glue("./data/final/persona/persona_group_{params$num_clusters}.tsv")))
metadata <- jsonlite::read_json(here("./data/original/surveys/02-self_assessment_metadata.json"))

gp_col <- glue::glue("group{params$num_clusters}")

counts <- persona %>%
  dplyr::group_by((!!sym(gp_col)), qbase, question_text) %>%
  dplyr::count(response) %>%
  tidyr::drop_na() %>%
  dplyr::ungroup()
```

```{r}
knitr::include_graphics(here::here(glue::glue(
  "./output/persona/dendogram_{params$num_clusters}.png"
)))
```


```{r}
persona %>%
  dplyr::filter(qbase == "Q1.3") %>%
  dplyr::group_by((!!sym(gp_col))) %>%
  summarize(n = n())
```

# Question Bar Graphs

```{r}
brewer.pal(8, "Dark2")
display.brewer.pal(8, "Dark2")
COLORS <- brewer.pal(8, "Dark2")[c(1:4, 6)]
```


```{r}
for (q in unique(counts$qbase)) {
  print(q)
  if (q %in% c("Q7.2", "Q7.3", "Q7.4")) {next}

  g <- plot_question_bar(dplyr::filter(counts, qbase == q))
  pth <- here("./output", "persona", glue::glue("group_descriptives_{params$num_clusters}"), glue::glue("{q}.png"))
  #print(pth)
  print(g)
  ggsave(filename = pth, plot = g, width = 8, height = 5, units = "in")
  #break
}
```

# Likert table

```{r, fig.width=8, fig.height=5}
likert <- persona %>%
  dplyr::filter(qbase == "Q7.2")

likert_questions_n <- metadata[["questions"]][["QID19"]][["subQuestions"]] %>%
  purrr::map(magrittr::extract2, "choiceText") %>%
  purrr::map_chr(magrittr::extract2, 1) %>%
  tibble::tibble(text = .) %>%
  dplyr::mutate(part = rownames(.)) %>%
  dplyr::mutate(question_part = paste0("Q7.2_", part)) %>%
  dplyr::full_join(likert, by = c("question_part")) %>%
  dplyr::select(id, (!!sym(gp_col)), qbase, qid, text, response)

```

## Heatmap

```{r}
likert_q_count_n <- likert_questions_n %>%
  dplyr::group_by((!!sym(gp_col)), text) %>%
  dplyr::count(response) %>%
  dplyr::filter(!is.na((!!sym(gp_col))))
```


```{r}
#table(likert_questions$text, likert_questions$response)
```

```{r, fig.width=13, fig.height=8}

# word wrap and re-order the x axis before plotting
x_wrap_len <- 10
x_levels <- stringr::str_wrap(c(NA,
                                "Strongly Disagree", "Disagree", "Somewhat Disagree",
                                "Neither Agree nor Disagree",
                                "Somewhat Agree", "Agree", "Strongly Agree"),
                              x_wrap_len)
x_factor <- factor(stringr::str_wrap(likert_q_count_n$response, x_wrap_len),
                   levels = x_levels)

g <- ggplot(likert_q_count_n,
       aes(x = x_factor,
           y = stringr::str_wrap(text, 50))) +
  geom_tile(aes(fill = n)) +
  geom_text(aes(label = n)) +
  facet_wrap(as.formula(paste("~", gp_col))) +
  scale_fill_viridis() +
  xlab("") +
  ylab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 1)) +
  NULL
print(g)
```

```{r}
ggsave(filename = here("./output",
                       "persona",
                       glue::glue("group_descriptives_{params$num_clusters}"),
                       "likert.png"),
       plot = g,
       width = 13,
       height = 8,
       units = "in")
```

## Heatmap by proportion in group

```{r}
likert_q_count_n_prop <- likert_questions_n %>%
  dplyr::group_by((!!sym(gp_col)), text) %>%
  dplyr::count(response) %>%
  dplyr::filter(!is.na((!!sym(gp_col)))) %>%
  dplyr::group_by((!!sym(gp_col))) %>%
  dplyr::mutate(rel_freq = n / sum(n))
```

```{r, fig.width=13, fig.height=8}
g <- ggplot(likert_q_count_n_prop,
       aes(x = x_factor,
           y = stringr::str_wrap(text, 50))) +
  geom_tile(aes(fill = rel_freq)) +
  geom_text(aes(label = round(rel_freq, 1))) +
  facet_wrap(as.formula(paste("~", gp_col))) +
  scale_fill_viridis() +
  xlab("") +
  ylab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 1)) +
  NULL
print(g)
```

```{r}
ggsave(filename = here("./output",
                       "persona",
                       glue::glue("group_descriptives_{params$num_clusters}"),
                       "likert_prop.png"),
       plot = g,
       width = 13,
       height = 8,
       units = "in")
```

# Free Response

- Q7.3: Please share what you most hope to learn from participating in this workshop and/or workshop series. 
- Q7.4: What do you want to know or be able to do after this workshop (or series of sessions) that you don't know or can't do right now?

## Paired responses by group


```{r}
reponse_table <- persona %>%
  dplyr::filter(qbase == "Q7.3" | qbase == "Q7.4") %>%
  dplyr::select((!!sym(gp_col)), id, qbase, response) %>%
  tidyr::pivot_wider(names_from = qbase, values_from = response) %>%
  dplyr::filter(! (is.na(Q7.3) & is.na(Q7.4))) %>%
  dplyr::arrange((!!sym(gp_col)), id)

reponse_table %>%
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::row_spec(which(reponse_table[gp_col] == 1), color = "white", background = .GlobalEnv$COLORS[1]) %>%
  kableExtra::row_spec(which(reponse_table[gp_col] == 2), color = "white", background = .GlobalEnv$COLORS[2]) %>%
  kableExtra::row_spec(which(reponse_table[gp_col] == 3), color = "white", background = .GlobalEnv$COLORS[3]) %>%
  kableExtra::row_spec(which(reponse_table[gp_col] == 4), color = "white", background = .GlobalEnv$COLORS[4]) %>%
  kableExtra::row_spec(which(reponse_table[gp_col] == 5), color = "white", background = .GlobalEnv$COLORS[5])
  
```
